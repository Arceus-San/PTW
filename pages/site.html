<!DOCTYPE html>
<html>
  <head>
    <title>LoireBNB</title>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="style.css">
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<!-- Nous chargeons les fichiers CDN de Leaflet. Le CSS AVANT le JS -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	
	
	<style type="text/css">
		#map{ /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
			height:450px;
		}
	</style>
  </head>
  <body>
		<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" ></script>
	<script src="https://code.jquery.com/jquery-latest.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="formData.json"></script>
	<script type="text/javascript">
	
		$(document).ready(function() {
		
			var cat='';
			var ser='';
			var trad1='';
			var result={
				etape1:[],
				etape2:[],
				etape3:[],
				etape4:[],
				etape5:[],
				etape6:[],
				etape7_1:[],
				etape7_2:[],
				etape7_3:[]
			};
		
			$( "#regForm" ).submit(function( event ) {
				event.preventDefault();
				$(".etape7").hide();
				//console.log($('#regForm').serialize());
				ser=$('#regForm').serialize();
				trad1=ser.split("&");
				traduction();
				console.log(result);
				
			});
			
			function traduction(){
			//console.log(trad1);
				for(var i=0;i<trad1.length;i++){
					var temp= trad1[i].split("=");
					switch(temp[0]){
							
						case "etape2":
						case "etape3":
						case "etape4":
							var arr=[];
							for(var j=0;j<formData[temp[0]][cat].length;j++){
								if(formData[temp[0]][cat][j].id==temp[1]){
									result[temp[0]].push(formData[temp[0]][cat][j].lib);
									break;
								}
							}
							break;
						
						case "etape1":
						case "etape5":
						case "etape6":
						case "etape7_1":
						case "etape7_2":
							for(var j=0;j<formData[temp[0]].length;j++){
								if(formData[temp[0]][j].id==temp[1]){
									result[temp[0]].push(formData[temp[0]][j].lib);
									break;
								}
							}
							break;
							
						case "etape7_3":
							result[temp[0]].push(temp[1]);
							break;
						
						
					}
					
					
				}
				var json = JSON.stringify(result);
				
				$.ajax({
					method: 'GET',
					url: 'localhost:8080/search',
					data: json,
					dataType: json,
					success: function(data) {
						///que faire avec les données ????
						data.forEach(function(h) {
							//afficher l'hébergement h
							//ajouter le marqueur sur la carte
						});
					},
					error: function(a,errorCode, errorThrown) {
						//pendant le dev.
					}
				})
				
				
				
				
			}
			
			
			function etape1(){
				//$(".etape1").append("<p>Catégorie :</p>");
				
				for(var i=0;i<formData.etape1.length;i++){
					$(".etape1").append("<input type='radio' name='etape1' value="+formData.etape1[i].id+">"+formData.etape1[i].lib+"<br>");
				}

				$(".etape1").append("<input type='button' id='etape1' value='Suivant'>");

				$("#etape1").click(function(){
					cat=$("input[name='etape1']:checked").val();
					$(".etape1").hide();
					etape2();
				});
			}

			function etape2(){
				$(".etape2").show();
				$(".etape2").append("<p>Catégorie :</p>");
				for(var i=0;i<formData.etape2[cat].length;i++){
					$(".etape2").append("<input type='checkbox' name='etape2' value="+formData.etape2[cat][i].id+">"+formData.etape2[cat][i].lib+"<br>")
				}
				$(".etape2").append("<input type='button' id='etape2' value='Suivant'>");

				$("#etape2").click(function(){
					$(".etape2").hide();
					if(cat=='h1'){
						etape5();
					}else{
						etape3();
					}
				});
			}
			
			
			function etape3(){
				$(".etape3").show();

				if(cat=='c1'){
					$(".etape3").append("<p>Hébergement :</p>");
				} else if(cat=='l1'){
					$(".etape3").append("<p>Nombre de chambres</p>");
				}

				for(var i=0;i<formData.etape3[cat].length;i++){
					$(".etape3").append("<input type='checkbox' name='etape3' value="+formData.etape3[cat][i].id+">"+formData.etape3[cat][i].lib+"<br>")
				}

				$(".etape3").append("<input type='button' id='etape3' value='Suivant'>");

				$("#etape3").click(function(){
					$(".etape3").hide();
					etape4();
				});
			}

			function etape4(){
				$(".etape4").show();

				if(cat=='c1'){
					$(".etape4").append("<p>Services proposés :</p>");
				} else if(cat=='l1'){
					$(".etape4").append("<p>Nombre de personnes :</p>");
				}

				for(var i=0;i<formData.etape4[cat].length;i++){
					$(".etape4").append("<input type='checkbox' name='etape4' value="+formData.etape4[cat][i].id+">"+formData.etape4[cat][i].lib+"<br>")
				}

				$(".etape4").append("<input type='button' id='etape4' value='Suivant'>");

				$("#etape4").click(function(){
					$(".etape4").hide();
					etape5();
				});
			}

			function etape5(){
				$(".etape5").show();

				$(".etape5").append("<p>Catégorie :</p>");

				for(var i=0;i<formData.etape5.length;i++){
					$(".etape5").append("<input type='checkbox' name='etape5' value="+formData.etape5[i].id+">"+formData.etape5[i].lib+"<br>");
				}

				$(".etape5").append("<input type='button' id='etape5' value='Suivant'>");

				$("#etape5").click(function(){
					$(".etape5").hide();
					etape6();
				});
			}

			function etape6(){
				$(".etape6").show();

				$(".etape6").append("<p>Equipements :</p>");

				for(var i=0;i<formData.etape6.length;i++){
					$(".etape6").append("<input type='checkbox' name='etape6' value="+formData.etape6[i].id+">"+formData.etape6[i].lib+"<br>");
				}

				$(".etape6").append("<input type='button' id='etape6' value='Suivant'>");

				$("#etape6").click(function(){
					$(".etape6").hide();
					etape7();
				});
			}

			function etape7(){
				$(".etape7").show();

				$(".etape7").append("<p>Département :</p>");

				for(var i=0;i<formData.etape7_1.length;i++){
					$(".etape7").append("<input type='checkbox' name='etape7_1' value="+formData.etape7_1[i].id+">"+formData.etape7_1[i].lib+"<br>");
				}

				$(".etape7").append("<p>Autres Options :</p>");

				for(var i=0;i<formData.etape7_2.length;i++){
					$(".etape7").append("<input type='checkbox' name='etape7_2' value="+formData.etape7_2[i].id+">"+formData.etape7_2[i].lib+"<br>");
				}

				$(".etape7").append("<p>Ville :</p>");

				$(".etape7").append("<input type='text' name='etape7_3'><br>");

				$("#regForm").append("<input type='submit' id='btn1'>");
			}

			etape1();
			
			
			var cities = L.layerGroup();
		function hotel(cities){
			$.getJSON('hôtel.json',function(data){
					var objet_type = {};
			
			function layer(id,val,Icon){
			for (i=0;i<val.length;i++){
				var nom = val[i].fields.nomoffre;
				var coor = val[i].geometry.coordinates;
				var coor2 = [coor[1],coor[0]];
				var popup = L.popup().setContent("<br>"+"<b>"+nom+"</b>"+"</br>" + id);
				var type = L.marker(coor2,{icon: Icon}).bindPopup(popup).addTo(cities);
				}
				console.log(cities);
<!-- 				overlays[C]=cities; -->
			}
		
			$("#checkBox1").change(function(){
			if($(this).is(':checked')) {
				cities.clearLayers();
				var valeur = $(this).val();
				var id = valeur ;
				var val = data;
				var Icon = L.icon({
				iconUrl: 'Icons_markers/'+valeur+'.png',
				iconSize:     [18, 25], // size of the icon
				shadowSize:   [18, 25], // size of the shadow
				iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				shadowAnchor: [4, 62],  // the same for the shadow
				popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
				});
				layer(id,val,Icon); 
				}
			});
			
});		
};

		function locatif(cities){
			$.getJSON('locatif.json',function(data){
			
			console.log(data[0]);		
			
			var objet_type = {};
			
			function layer(id,val){
			for (i=0;i<val.length;i++){
				var nom = val[i].fields.nomoffre;
				var coor = val[i].geometry.coordinates;
				var valeur = val[i].fields.typehabitation;
				var rel ;
				if (typeof valeur == 'undefined'){
					rel = "undefined";
				}else{
				rel = valeur.split(",")[0];
				}
				var coor2 = [coor[1],coor[0]];
				var Icon = L.icon({
				iconUrl: 'Icons_markers/'+rel+'.png',
				iconSize:     [18, 25], // size of the icon
				shadowSize:   [18, 25], // size of the shadow
				iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				shadowAnchor: [4, 62],  // the same for the shadow
				popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
				});
				var popup = L.popup().setContent("<br>"+"<b>"+nom+"</b>"+"</br>" + id +"<br>"+rel+"<br>");
				var type = L.marker(coor2,{icon: Icon}).bindPopup(popup).addTo(cities);
				}
				console.log(cities);
<!-- 				
			}
			
		var filtre = "type"; 
		var filtre2 ="capacitenbchambres";
		function filtrage (data,objet_type,filtre){
			console.log("data",data);
			console.log("objet_type",objet_type);
			var i;	
			var nbr = 0;
			var list_tout_type = [];
			for (i = 0; i < (data.length); i++) {
				var type = data[i].fields[filtre];
					if (typeof type !== 'undefined'){
					var rel ;
						if (!isNaN(type) ){
							rel = type.toString();
						}else{
						rel = type.split(",");
						}
							for (var tempo in rel) {
								if(rel.hasOwnProperty(tempo)){
									if (rel[tempo] in objet_type){
									objet_type[rel[tempo]].push(data[i]);	
									}else{
									objet_type[rel[tempo]] = [data[i]];
									}
										
								}
							}
							
						}			
			}
			console.log(objet_type);
			console.log(Object.keys(objet_type));
			console.log(Object.values(objet_type));
		}
		filtrage(data,objet_type,filtre);

		
			$("input[name=choix]").change(function(){
			if($(this).is(':checked')) {
				cities.clearLayers();
				var id = $(this).val();
				console.log(id);
				var v = objet_type[id];
				objet_type = {};
				filtrage(v,objet_type,filtre2);
				layer(id,v); 
				}
				
			});
			
});		
};

	$('#checkBox').click(function(){
		if ($('#checkBox').is(':checked')){
			$("#locatif").show();
			cities.clearLayers();
			locatif(cities);
		}else{
			$("#locatif").hide();
			cities.clearLayers();
			hotel(cities);
		}
		});
			// On initialise la latitude et la longitude de Paris (centre de la carte)
			var lat = 47.361903;
			var lon = -0.861994;
			var macarte = null;
			// Fonction d'initialisation de la carte
				var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
				'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
				mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
				
				var fond = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                    // Il est toujours bien de laisser le lien vers la source des données
                    attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
                    minZoom: 1,
                    maxZoom: 40
                })
				
				var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox.light', attribution: mbAttr}),
					streets  = L.tileLayer(mbUrl, {id: 'mapbox.streets',   attribution: mbAttr});
				
				var baseLayers = {
					"Fond" : fond
				};
				var overlays = {
					"Cities": cities
					
				}
				// Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
                macarte = L.map('map',{
					center: [lat, lon],
					zoom: 8,
					layers: [fond,cities]
				});
				L.control.layers(baseLayers,overlays).addTo(macarte);
		
		});
			
			
	</script>
	
	<div class="container-fluid">
	
		<div class="row ">

			<div id="tete" class="col-md-auto">

			<h1>LoireBNB</h1>

			<h2>Choisissez votre hébergement</h2>

			<form id="regForm" action="">
			
				<div class="etape1">
				
				</div>
				
				<div class="etape2">
				
				</div>

				<div class="etape3">
				
					
				</div>

				<div class="etape4">
				
					
				</div>

				<div class="etape5">
				
					
				</div>

				<div class="etape6">
				
					
				</div>

				<div class="etape7">
				
					
				</div>
			
			</form>

			</div>
			
		</div>
		
		<div class="row">
		
			<div id="info" class="col-md-auto">
				<!-- Ici s'affichera les infos du point -->
				<p>test</p>
			</div>
			
		
			<div class="col">
			<div id="map">
				<!-- Ici s'affichera la carte -->
			</div>
			</div>
			
		</div>
		
		
		<div class="row">
		
			<div class="col-md-auto">
		
				<form>
				<input type=checkbox name=Choix1 id="checkBox" value="Type d'habitation"> <b>Type d'habitation :</b>
						<div id="locatif" hidden>
						<input type=radio name=choix value="Meublés"> Meublés
						<input type=radio name=choix value="Chambres d'hôtes"> Chambres d'hôtes
						<input type=radio name=choix value="Hébergement insolite"> Hébergement insolite
						<input type=radio name=choix value="Locatif sur camping"> Locatif sur camping
						<input type=radio name=choix value="Village locatif"> Village locatif
						<input type=radio name=choix value="Bateau"> Bateau
						</div>
				<input type=checkbox name=Choix1 id="checkBox1" value="Hôtel"> <b>Hôtel :</b>
				<div id="chambres" >
						<input type=checkbox name=choix value="1"> 1
						<input type=checkbox name=choix value="2"> 2
						<input type=checkbox name=choix value="3">3
						<input type=checkbox name=choix value="4"> 4
						<input type=checkbox name=choix value="5"> 5
						<input type=checkbox name=choix value="6"> 6
						<input type=checkbox name=choix value="7"> 7
						<input type=checkbox name=choix value="8"> 8
						<input type=checkbox name=choix value="9"> 9
						</div>
				</form>
			
			</div>
			
		</div>
		
	</div>

  </body>
</html>